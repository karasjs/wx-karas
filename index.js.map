{"version":3,"file":"index.js","sources":["src/index.js"],"sourcesContent":["import karas from 'karas';\nimport { version } from '../package.json';\n\nkaras.inject.requestAnimationFrame = function(cb) {\n  setTimeout(cb, 1000 / 60);\n};\n\nclass Root extends karas.Root {\n  appendTo(dom) {\n    this.__dom = dom;\n    this.__children = karas.builder.initRoot(this.__cd, this);\n    this.__initProps();\n    this.__root = this;\n    this.cache = !!this.props.cache;\n    this.__refreshLevel = karas.refresh.level.REFLOW;\n    this.__ctx = dom.getContext('2d');\n    this.__renderMode = karas.mode.CANVAS;\n    this.__defs = {\n      clear() {},\n    };\n    this.refresh(null, true);\n  }\n}\n\n// Root引用指过来\nlet createVd = karas.createVd;\nkaras.createVd = function(tagName, props, children) {\n  if(['canvas', 'svg'].indexOf(tagName) > -1) {\n    return new Root(tagName, props, children);\n  }\n  return createVd(tagName, props, children);\n};\n\nconst IMG = karas.inject.IMG;\nconst INIT = karas.inject.INIT;\nconst LOADING = karas.inject.LOADING;\nconst LOADED = karas.inject.LOADED;\n\nkaras.inject.measureImg = function(url, cb, optinos = {}) {\n  let { root: { dom, ctx } } = optinos;\n  let cache = IMG[url] = IMG[url] || {\n    state: INIT,\n    task: [],\n  };\n  if(cache.state === LOADED) {\n    cb(cache);\n  }\n  else if(cache.state === LOADING) {\n    cache.task.push(cb);\n  }\n  else {\n    cache.state = LOADING;\n    cache.task.push(cb);\n    let img = dom.createImage();\n    img.onload = function() {\n      cache.state = LOADED;\n      cache.success = true;\n      cache.width = img.width;\n      cache.height = img.height;\n      cache.source = img;\n      cache.url = url;\n      let list = cache.task.splice(0);\n      list.forEach(cb => cb(cache));\n    };\n    img.onerror = function() {\n      cache.state = LOADED;\n      cache.success = false;\n      cache.url = url;\n      let list = cache.task.splice(0);\n      list.forEach(cb => cb(cache));\n    }\n    img.src = url;\n  }\n};\n\nkaras.inject.isDom = function(o) {\n  return o && karas.util.isFunction(o.createImage);\n}\n\nconst CANVAS = {};\nconst CANVAS_LIST = [];\nconst WEBGL_LIST = [];\n\nfunction cache(key, width, height, hash, message) {\n  let o;\n  if(!key) {\n    let target = hash === CANVAS ? CANVAS_LIST : WEBGL_LIST;\n    if(target.length) {\n      o = target.pop();\n    }\n    else {\n      o = wx.createOffscreenCanvas(width, height);\n    }\n  }\n  else if(!hash[key]) {\n    o = hash[key] = wx.createOffscreenCanvas(width, height);\n  }\n  else {\n    o = hash[key];\n  }\n  o.width = width;\n  o.height = height;\n  return {\n    canvas: o,\n    ctx: hash === CANVAS ? o.getContext('2d')\n      : (o.getContext('webgl') || o.getContext('experimental-webgl')),\n    draw() {\n      // 空函数，仅对小程序提供hook特殊处理，flush缓冲\n    },\n    available: true,\n    release() {\n      if(hash === CANVAS) {\n        CANVAS_LIST.push(this.canvas);\n      }\n      else {\n        WEBGL_LIST.push(this.canvas);\n      }\n      this.canvas = null;\n      this.ctx = null;\n    },\n  };\n}\n\nfunction cacheCanvas(key, width, height, message) {\n  return cache(key, width, height, CANVAS, message);\n}\n\nkaras.inject.hasCacheCanvas = function(key) {\n  return key && CANVAS.hasOwnProperty(key);\n};\n\nkaras.inject.getCacheCanvas = function(width, height, key, message) {\n  return cacheCanvas(key, width, height, message);\n};\n\nkaras.inject.releaseCacheCanvas = function(o) {\n  CANVAS_LIST.push(o);\n};\n\nkaras.inject.delCacheCanvas = function(key) {\n  key && delete CANVAS[key];\n};\n\nkaras.wxVersion = version;\n\nexport default karas;\n"],"names":["karas","inject","requestAnimationFrame","cb","setTimeout","Root","dom","__dom","__children","builder","initRoot","__cd","__initProps","__root","cache","props","__refreshLevel","refresh","level","REFLOW","__ctx","getContext","__renderMode","mode","CANVAS","__defs","clear","createVd","tagName","children","indexOf","IMG","INIT","LOADING","LOADED","measureImg","url","optinos","root","ctx","state","task","push","img","createImage","onload","success","width","height","source","list","splice","forEach","onerror","src","isDom","o","util","isFunction","CANVAS_LIST","WEBGL_LIST","key","hash","message","target","length","pop","wx","createOffscreenCanvas","canvas","draw","available","release","cacheCanvas","hasCacheCanvas","hasOwnProperty","getCacheCanvas","releaseCacheCanvas","delCacheCanvas","wxVersion","version"],"mappings":"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"}